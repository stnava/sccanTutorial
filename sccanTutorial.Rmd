---
title: "SCCAN tutorial and tests"
output: pdf_document
---
```{r global options, include=FALSE,echo=TRUE}
library(knitr)
library(visreg)
invisible(suppressMessages(library(ANTsR)))
rootdir<-"/Users/stnava2/code/sccanTutorial"
if ( ! file.exists(rootdir) ) {
  dirs<-list.dirs(path = path.expand("~"), full.names = TRUE, recursive = TRUE)
  rootdir<-dirs[ grep('sccanTutorial',dirs)[1] ]
  rootdir<-path.expand(rootdir)
}
opts_knit$set(root.dir=rootdir)
```

# Introduction

## Brief summary
Sparse canonical correlation analysis for neuroimaging (SCCAN) is a general purpose
tool for "two-sided" multiple regression.  This allows one to symmetrically
compare one matrix of data to another and find linear relationships between
them in a low-dimensional space.  SCCAN derives from classic canonical correlation
analysis and also relates to singular value decomposition.  To handle data with $p>>n$,
SCCAN uses high-dimensional regularization methods common in $\ell_1$ regression
and spatial regularization to help ensure the biological plausibility of statistical
maps in medical imaging.  This problem is a difficult optimization ($np$-hard)
and, to improve solution interpetability and stability, SCCAN allows one to
to use prior knowledge to constrain the solution space.

# Examples

Perhaps the best way to understand how to use SCCAN is by running example data.

## Read example data
We read in some neuroimaging and cognitive data below.
```{r fig.width=8, fig.height=4, echo=TRUE, messages=FALSE }
gfnl<-list.files(path=rootdir, pattern = glob2rx("pbac*mha"),
  full.names = T,recursive = T) 
ptrainimg<-as.matrix(antsImageRead(gfnl[2],2))
ptestimg<-as.matrix(antsImageRead(gfnl[1],2))
gfnl<-list.files(path=rootdir, pattern = "gmask.nii.gz",
  full.names = T,recursive = T) 
mask<-antsImageRead( gfnl[1], 3 )
f1<-list.files(path =rootdir, pattern = "pbac_train_cog.csv",
  recursive=TRUE, full.names = TRUE, include.dirs=TRUE )
f2<-list.files(path = rootdir, pattern = "pbac_test_cog.csv",
  recursive=TRUE, full.names = TRUE )
ptraincog<-read.csv(f1)
ptestcog<-read.csv(f2)
```
We already divided the dataset into two different groups - one for testing and 
one for training.  

## Sparse regression

Use sccan to find brain regions relating to age.  We impose a 
"cluster threshold" regularization to prevent isolated voxels
from appearing in the solution.
```{r sparreg,fig.width=8, fig.height=4, echo=TRUE, messages=FALSE }
agemat<-matrix( ptraincog$age, ncol=1)
for ( sp in c(-0.01,-0.05,-0.1,-0.15,-0.2) ) {
  ageresult<-sparseDecom2( inmatrix=list(ptrainimg,agemat), its=10, mycoption=2,
    sparseness=c(sp,0.9), inmask=c(mask,NA),nvecs=2, cthresh=c(50,0))
  plot( ageresult$projections[,1], ageresult$projections2[,1] )
  # convert output images to matrix so we can validate in test data
  ccamat<-imageListToMatrix( ageresult$eig1, mask )
  agepred<-ptestimg %*% t(ccamat)
  print(cor.test( agepred[,1],  ptestcog$age ))
  }
```

## Sparse regression with prior initialization

Use sccan to find brain regions relating to age.

## Sparse regression with nuisance variables

## Bidirectional regression with nuisance variables

